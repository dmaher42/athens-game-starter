  `,document.head.appendChild(s)}function zu(s){switch(s){case"KeyH":return"H";case"F9":case"F10":case"F11":case"F12":return s;case"ControlLeft":case"ControlRight":return"Ctrl";default:return s.startsWith("Key")&&s.length===4?s.slice(3):s}}function lB({getPosition:s,getDirection:e,onPin:t,onSetLightingPreset:n,lightingPresets:i}={}){if(!(typeof window<"u"&&window.SHOW_HUD===!0))return null;const a=document.createElement("div");Object.assign(a.style,{color:"#fff",font:"12px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto",textShadow:"0 1px 2px rgba(0,0,0,0.45)",userSelect:"none",pointerEvents:"none"});const o=document.createElement("div");Object.assign(o.style,{width:"88px",height:"88px",borderRadius:"50%",border:"2px solid rgba(255,255,255,0.75)",position:"relative",marginBottom:"8px"});const c=document.createElement("div");Object.assign(c.style,{position:"absolute",left:"50%",top:"50%",width:"2px",height:"40px",background:"rgba(255,0,0,0.9)",transformOrigin:"50% 100%",borderRadius:"2px",transform:"translate(-1px, -40px) rotate(0deg)"}),o.appendChild(c),Object.entries({N:0,E:90,S:180,W:270}).forEach(([E,B])=>{const D=document.createElement("div");D.textContent=E,Object.assign(D.style,{position:"absolute",left:"50%",top:"50%",transform:`translate(-50%,-50%) rotate(${B}deg) translate(0,-38px) rotate(${-B}deg)`,fontWeight:700,letterSpacing:"0.5px"}),o.appendChild(D)});const h=document.createElement("div");h.style.pointerEvents="auto",h.style.background="rgba(0,0,0,0.55)",h.style.backdropFilter="blur(3px)",h.style.padding="8px 10px",h.style.borderRadius="8px",h.style.minWidth="220px",h.innerHTML=['<div><b>Pos</b> <span id="hud-pos">(x,y,z)</span></div>','<div><b>Bear</b> <span id="hud-bear">0° N</span></div>','<div style="opacity:.8">Press <b>P</b> to drop a pin</div>'].join("");const u=document.createElement("div");Object.assign(u.style,{marginTop:"6px",paddingTop:"6px",borderTop:"1px solid rgba(255,255,255,0.12)",display:"none"}),h.appendChild(u);const d=new Map,f=()=>{u.style.display=d.size?"block":"none"},A=(E,B)=>{if(!E)return;const D=typeof B=="string"?B.trim():"";let F=d.get(E);if(!D){F&&(d.delete(E),F.remove(),f());return}F||(F=document.createElement("div"),Object.assign(F.style,{opacity:"0.75",fontSize:"11px",letterSpacing:"0.03em",textTransform:"none",marginTop:d.size?"4px":"0"}),d.set(E,F),u.appendChild(F)),F.textContent=D,f()},m=[{name:"dawn",label:"Dawn"},{name:"noon",label:"High Noon"},{name:"dusk",label:"Dusk"},{name:"night",label:"Night"}].filter(({name:E})=>i?i[E]!=null:!0);if(m.length&&!h.querySelector(".hud-lighting-presets")){const E=document.createElement("div");E.className="hud-lighting-presets",Object.assign(E.style,{marginTop:"8px",paddingTop:"6px",borderTop:"1px solid rgba(255,255,255,0.15)",pointerEvents:"auto"});const B=document.createElement("div");B.textContent="Lighting Presets",Object.assign(B.style,{fontWeight:600,letterSpacing:"0.08em",fontSize:"11px",opacity:"0.85",textTransform:"uppercase"}),E.appendChild(B);const D=document.createElement("div");Object.assign(D.style,{display:"flex",flexWrap:"wrap",gap:"6px",marginTop:"6px"});const F=[{name:"dawn",codes:["Digit1","Numpad1"],keys:["1"]},{name:"noon",codes:["Digit2","Numpad2"],keys:["2"]},{name:"dusk",codes:["Digit3","Numpad3"],keys:["3"]},{name:"night",codes:["Digit4","Numpad4"],keys:["4"]}],N=new Set(m.map(k=>k.name)),O=new Map;for(const k of m){const q=i?.[k.name]||{},U=document.createElement("button");U.type="button";const te=q.label||k.label;U.textContent=te,Object.assign(U.style,{padding:"4px 8px",borderRadius:"4px",border:"1px solid rgba(255,255,255,0.35)",background:"rgba(0,0,0,0.35)",color:"inherit",font:"inherit",cursor:"pointer",pointerEvents:"auto",transition:"background 0.2s ease, border-color 0.2s ease"}),U.addEventListener("mouseenter",()=>{U.style.background="rgba(255,255,255,0.18)",U.style.borderColor="rgba(255,255,255,0.55)"}),U.addEventListener("mouseleave",()=>{U.style.background="rgba(0,0,0,0.35)",U.style.borderColor="rgba(255,255,255,0.35)"});const ge=q.hotkey||"";ge?U.title=`Set ${te} lighting (Hotkey ${ge})`:U.title=`Set ${te} lighting`,U.addEventListener("click",re=>{re.preventDefault(),typeof n=="function"&&n(k.name)}),D.appendChild(U)}F.filter(k=>N.has(k.name)).forEach(k=>{for(const q of k.codes)O.set(q,k.name);for(const q of k.keys)O.set(q,k.name)}),E.appendChild(D),h.appendChild(E),h._presetKeyBindings=O}a.appendChild(o),a.appendChild(h),yh("topRight").appendChild(a);const x=h.querySelector("#hud-pos"),b=h.querySelector("#hud-bear"),y=E=>{const D=(Math.atan2(E.x,E.z)*180/Math.PI+360)%360,F=["N","NE","E","SE","S","SW","W","NW","N"],N=Math.round(D/45);return{deg:Math.round(D),label:F[N]}};let _=0,w=!0;const S=()=>{if(w){try{const E=s?.(),B=e?.();if(E&&(x.textContent=`(${E.x.toFixed(1)}, ${E.y.toFixed(1)}, ${E.z.toFixed(1)})`),B){const D=y(B);b.textContent=`${D.deg}° ${D.label}`,c.style.transform=`translate(-1px, -40px) rotate(${D.deg}deg)`}}catch{}_=requestAnimationFrame(S)}};S();const M=()=>h?._presetKeyBindings instanceof Map?h._presetKeyBindings:null,v=E=>{if(E.key?.toLowerCase()==="p"){const F=s?.();F&&(t?.(F),console.log(`[PIN] @ (${F.x.toFixed(2)}, ${F.y.toFixed(2)}, ${F.z.toFixed(2)})`))}const B=M();if(!B||typeof n!="function"||E.repeat)return;const D=B.get(E.code)||B.get(E.key);D&&(E.preventDefault(),n(D))};return window.addEventListener("keydown",v),{dispose(){w=!1,cancelAnimationFrame(_),window.removeEventListener("keydown",v),a.remove()},setStatusLine:A,rootElement:h}}const Hu={yawSpeed:{min:.1,max:2,step:.05,label:"Yaw Speed",suffix:"rad/s"},pitchSpeed:{min:.1,max:2,step:.05,label:"Pitch Speed",suffix:"rad/s"},zoomSpeed:{min:.5,max:8,step:.1,label:"Zoom Speed",suffix:"u/s"},minPitch:{min:-1,max:0,step:.01,label:"Min Pitch",suffix:"rad"},maxPitch:{min:0,max:1,step:.01,label:"Max Pitch",suffix:"rad"},minDist:{min:1.5,max:6,step:.1,label:"Min Distance",suffix:"m"},maxDist:{min:4,max:12,step:.1,label:"Max Distance",suffix:"m"}},gy=(s,e="")=>{if(!Number.isFinite(s))return`0${e?" "+e:""}`;const n=Math.abs(s)>=10?1:2,i=s.toFixed(n);return e?`${i} ${e}`:i};function hB(s,e,t){const n=document.createElement("div");Object.assign(n.style,{display:"flex",flexDirection:"column",gap:"4px"});const i=document.createElement("div");Object.assign(i.style,{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"8px",fontSize:"11px",textTransform:"uppercase",letterSpacing:"0.06em",opacity:"0.85"});const r=document.createElement("span");r.textContent=e.label,i.appendChild(r);const a=document.createElement("span");a.style.fontVariantNumeric="tabular-nums",a.style.opacity="0.9",i.appendChild(a);const o=document.createElement("input");return o.type="range",o.min=String(e.min),o.max=String(e.max),o.step=String(e.step),o.name=s,o.setAttribute("aria-label",e.label),Object.assign(o.style,{width:"100%"}),o.addEventListener("input",()=>{const c=Number.parseFloat(o.value);a.textContent=gy(c,e.suffix),t(s,c)}),n.appendChild(i),n.appendChild(o),{wrapper:n,slider:o,valueEl:a}}function lm(s,e,t){const n=document.createElement("label");Object.assign(n.style,{display:"flex",alignItems:"center",gap:"8px",cursor:"pointer",fontSize:"12px",opacity:"0.9"});const i=document.createElement("input");i.type="checkbox",i.name=e,i.addEventListener("change",()=>{t(e,i.checked)});const r=document.createElement("span");return r.textContent=s,n.appendChild(i),n.appendChild(r),{wrapper:n,checkbox:i}}function uB(s){if(!(s instanceof HTMLElement))return{dispose(){}};const e={settings:Af(),disposed:!1},t=document.createElement("section");t.className="hud-camera-settings",Object.assign(t.style,{marginTop:"8px",paddingTop:"8px",borderTop:"1px solid rgba(255,255,255,0.15)",pointerEvents:"auto"});const n=document.createElement("div");Object.assign(n.style,{display:"flex",alignItems:"center",justifyContent:"space-between",gap:"8px"});const i=document.createElement("span");i.textContent="Camera",Object.assign(i.style,{fontWeight:600,letterSpacing:"0.08em",fontSize:"11px",textTransform:"uppercase",opacity:"0.85"});const r=document.createElement("button");r.type="button",r.setAttribute("aria-expanded","false"),r.title="Camera settings",r.setAttribute("aria-label","Camera settings"),r.textContent="⚙",Object.assign(r.style,{width:"22px",height:"22px",borderRadius:"50%",border:"1px solid rgba(255,255,255,0.4)",background:"rgba(0,0,0,0.35)",color:"inherit",fontSize:"12px",lineHeight:"1",display:"grid",placeItems:"center",cursor:"pointer",padding:"0"});const a=document.createElement("div");Object.assign(a.style,{marginTop:"8px",padding:"8px",borderRadius:"6px",background:"rgba(0,0,0,0.35)",backdropFilter:"blur(4px)",maxHeight:"260px",overflowY:"auto",display:"none"});const o={},c=document.createElement("div");Object.assign(c.style,{display:"flex",flexDirection:"column",gap:"10px"});const l=(p,x)=>{e.disposed||Nu({[p]:x})};for(const p of["yawSpeed","pitchSpeed","zoomSpeed","minPitch","maxPitch","minDist","maxDist"]){const x=Hu[p],b=hB(p,x,l);o[p]=b,c.appendChild(b.wrapper)}const h=document.createElement("div");Object.assign(h.style,{display:"flex",flexDirection:"column",gap:"6px",marginBottom:"8px"});const u=lm("Enable Arrow Orbit","enableArrowOrbit",(p,x)=>{e.disposed||Nu({[p]:x})}),d=lm("Invert Pitch","invertPitch",(p,x)=>{e.disposed||Nu({[p]:x})});h.appendChild(u.wrapper),h.appendChild(d.wrapper),a.appendChild(h),a.appendChild(c),n.appendChild(i),n.appendChild(r),t.appendChild(n),t.appendChild(a);const f=p=>{e.settings=p,u.checkbox.checked=p.enableArrowOrbit,d.checkbox.checked=p.invertPitch;for(const x of Object.keys(Hu)){const b=o[x];if(!b)continue;const y=p[x]??Pt[x];b.slider.value=String(y),b.valueEl.textContent=gy(y,Hu[x].suffix)}},A=()=>{a.style.display!=="none"?(a.style.display="none",r.setAttribute("aria-expanded","false")):(a.style.display="block",r.setAttribute("aria-expanded","true"))},g=p=>{p.preventDefault(),A()};r.addEventListener("click",g);const m=mf(p=>{e.disposed||f(p)});return f(e.settings),s.appendChild(t),{dispose(){e.disposed||(e.disposed=!0,m?.(),r.removeEventListener("click",g),t.remove())}}}function dB(s,e,t=16724838){const n=new _t;n.name="Pin";const i=new Be(new Lt(.05,.05,1.2,8),new tt({color:16777215,roughness:.8}));i.position.y=.6;const r=new Be(new pi(.5,.3),new tt({color:t,side:gn,roughness:.6}));return r.position.set(.3,1,0),r.rotation.y=Math.PI/2,n.add(i,r),n.position.copy(e),n.renderOrder=2,n.userData.noCollision=!0,s.add(n),n}function fB(s){if(!s)return;const e=s?.userData?.getHeightAt;if(typeof e=="function"){const o=e(0,0);if(Number.isFinite(o))return}const t=new Ah;t.firstHitOnly=!0;const n=[s],i=200,r=-400;function a(o,c){t.set(new C(o,i,c),new C(0,-1,0));const l=t.intersectObjects(n,!0)[0];if(l)return l.point.y;t.set(new C(o,r,c),new C(0,1,0));const h=t.intersectObjects(n,!0)[0];return h?h.point.y:0}s.userData=s.userData||{},s.userData.getHeightAt=a}function pB(s,e,t,n,i=6,r=120){const a=e?.userData?.getHeightAt?.bind(e?.userData);if(!a)return console.warn("[occluder] terrain.getHeightAt missing"),null;const o=new C(t.x,0,t.y),c=new C(n.x,0,n.y),l=new $(c.x-o.x,c.z-o.z);l.lengthSq()===0?l.set(1,0):l.normalize();const h=new $(-l.y,l.x),u=i*.5,d=new Float32Array((r+1)*2*3),f=new ut(d,3),A=new $e;A.setAttribute("position",f);const g=[];for(let b=0;b<r;b++){const y=b*2;g.push(y,y+1,y+2,y+1,y+3,y+2)}A.setIndex(g);const m=.05;for(let b=0;b<=r;b++){const y=b/r,_=ue.lerp(o.x,c.x,y),w=ue.lerp(o.z,c.z,y),S=(a(_,w)??0)+m,M=_-h.x*u,v=w-h.y*u,E=_+h.x*u,B=w+h.y*u,D=b*2*3,F=(b*2+1)*3;d[D+0]=M,d[D+1]=S,d[D+2]=v,d[F+0]=E,d[F+1]=S,d[F+2]=B}f.needsUpdate=!0,A.computeVertexNormals();const p=new tt({color:0,transparent:!1,depthWrite:!0,depthTest:!0,colorWrite:!1}),x=new Be(A,p);return x.name="WaterDepthOccluderRibbon",x.renderOrder=-2,x.receiveShadow=!1,x.castShadow=!1,x.userData.noCollision=!0,s.add(x),x}const AB=.05;function mB(s,e,t,n=0,{clampToSea:i=!1,seaLevel:r=0,minAboveSea:a=0}={}){const o=s?.userData?.getHeightAt?.(e,t);let c=Number.isFinite(o)?o:n;return i&&(c=Math.max(c,r+a)),c}function gd(s,e,t,n,i=AB,r={}){const a=mB(e,t,n,s.position?.y??0,r);return s.position.y=a+i,s.position.y}function yd(s){return Object.prototype.toString.call(s)==="[object Object]"}function na(...s){const e={};for(const t of s)if(yd(t))for(const[n,i]of Object.entries(t))yd(i)?e[n]=na(e[n],i):Array.isArray(i)?e[n]=[...i]:e[n]=i;return e}function ol(s){if(!s)return null;if(s.isVector3)return s.clone();if(Array.isArray(s))return new C(s[0]??0,s[1]??0,s[2]??0);if(typeof s=="object"){const{x:e=0,y:t=0,z:n=0}=s;return new C(e,t,n)}return typeof s=="number"?new C(s,s,s):null}function bd(s,e=0){return s?s.isEuler?s.clone():Array.isArray(s)?new an(s[0]??0,s[1]??e,s[2]??0):typeof s=="object"?new an(s.x??s.pitch??0,s.y??s.yaw??e,s.z??s.roll??0):typeof s=="number"?new an(0,s,0):new an(0,e,0):new an(0,e,0)}function gB(s={}){const e={...s};return s.position&&(e.position=ol(s.position)),s.rotation&&(e.rotation=bd(s.rotation)),s.scale?.isVector3?e.scale=s.scale.clone():Array.isArray(s.scale)?e.scale=[...s.scale]:yd(s.scale)&&(e.scale={...s.scale}),e}class yB{constructor({scene:e=null,parent:t=null,terrain:n=null,heightSampler:i=null,envCollider:r=null,renderer:a=null,spawnPlaceholder:o=null,logger:c=console,quietMissing:l=!1}={}){this.scene=e,this.parent=t||e,this.terrain=n,this.heightSampler=typeof i=="function"?i:e?.userData?.getHeightAt||null,this.envCollider=r,this.renderer=a,this.spawnPlaceholder=typeof o=="function"?o:null,this.logger=c||console,this.quietMissing=!!l,this.baseUrl=Hn(),this.globalDefaults={},this.results=[]}setTerrain(e){this.terrain=e}setHeightSampler(e){typeof e=="function"&&(this.heightSampler=e)}setParent(e){this.parent=e||this.scene}setSpawnPlaceholder(e){this.spawnPlaceholder=typeof e=="function"?e:null}resolveSurfaceOffset(e={}){const t=e.placement?.surfaceOffset;return typeof t=="number"?t:typeof e.surfaceOffset=="number"?e.surfaceOffset:typeof this.globalDefaults.surfaceOffset=="number"?this.globalDefaults.surfaceOffset:.05}resolveSnapOptions(e={}){const t=na({clampToSea:!0,seaLevel:ot},this.globalDefaults.snapOptions,e.snapOptions,e.placement?.snapOptions);return typeof t.minAboveSea!="number"&&(t.minAboveSea=.02),typeof t.seaLevel!="number"&&(t.seaLevel=ot),t}resolvePosition(e={}){const t=e.placement||{},i=(t.alignToTerrain??e.alignToTerrain??this.globalDefaults.alignToTerrain)!==!1,r=ol(t.position);if(!r)return null;const a=this.resolveSurfaceOffset(e);if(i&&typeof this.heightSampler=="function"){const o=this.heightSampler(r.x,r.z);Number.isFinite(o)?r.y=o+a:Number.isFinite(r.y)||(r.y=a)}else Number.isFinite(r.y)||(r.y=a);return r}prepareTransform(e={}){const t=e.placement||{},n=na(this.globalDefaults.loadOptions,e.loadOptions);this.renderer&&typeof n.renderer>"u"&&(n.renderer=this.renderer);const i=this.resolvePosition(e);i&&(n.position=i);const r=t.rotation||t.euler,a=typeof t.rotateY=="number"?t.rotateY:typeof e.rotateY=="number"?e.rotateY:void 0;return(r||typeof a=="number")&&(n.rotation=bd(r,a??0)),t.scale!==void 0?n.scale=t.scale:e.scale!==void 0&&(n.scale=e.scale),e.materialPreset&&!n.materialPreset&&(n.materialPreset=e.materialPreset),{options:n,position:n.position?ol(n.position):null,rotation:n.rotation?n.rotation.clone?.()??bd(n.rotation):null,scale:t.scale??e.scale,surfaceOffset:this.resolveSurfaceOffset(e),snapOptions:this.resolveSnapOptions(e)}}resolveUrls(e=[]){const t=[],n=new Set,i=r=>{if(typeof r!="string")return;const a=r.trim();a&&(n.has(a)||(n.add(a),t.push(a)))};for(const r of e){if(typeof r!="string")continue;const a=r.trim();if(!a)continue;if(/^https?:/i.test(a)||a.startsWith("data:")){i(a);continue}const o=os(a);o&&(i(xt(this.baseUrl,o)),i(o))}return t}applyCollisionSettings(e,t){if(!e)return;const n=!!t;e.traverse?.(i=>{i?.isMesh&&(i.userData=i.userData||{},i.userData.noCollision=!n)}),n&&typeof this.envCollider?.refresh=="function"&&this.envCollider.refresh()}snapObject(e,t){if(!e||!t?.position)return;const{position:n,surfaceOffset:i,snapOptions:r}=t,a=n.x??e.position?.x,o=n.z??e.position?.z;!Number.isFinite(a)||!Number.isFinite(o)||this.terrain&&gd(e,this.terrain,a,o,i,r)}reparent(e){!e||!this.parent||e.parent===this.parent||(e.parent?.remove?.(e),this.parent.add(e))}logMessage(e,t){if(!t)return;const n=this.logger||console;typeof n?.[e]=="function"?n[e](t):typeof n?.log=="function"&&n.log(t)}spawnFallbackPlaceholder(e,t){const n=e.placeholder||{};if(n.enabled===!1||typeof this.spawnPlaceholder!="function")return null;const i={...n};delete i.enabled,i.position||(i.position=t?.position?t.position.clone?.()??ol(t.position):null),typeof i.rotateY!="number"&&t?.rotation&&(i.rotateY=t.rotation.y),i.scale===void 0&&t?.scale!==void 0&&(i.scale=t.scale),i.collision===void 0&&(i.collision=!!e.collision),i.parent||(i.parent=this.parent||this.scene);try{return this.spawnPlaceholder(i)}catch(r){return this.logMessage("warn",`[LandmarkManager] Failed to spawn placeholder for ${e.name||e.id||"landmark"}`),this.logMessage("warn",r),null}}async attemptLoad(e,t,n,i){if(!e.length)return null;const r=t.name||t.id||"Landmark";for(const a of e){const o=gB(n.options);try{const c=await al(this.scene,a,o);if(!c)continue;if(this.reparent(c),this.snapObject(c,n),this.applyCollisionSettings(c,t.collision),typeof t.onLoaded=="function")try{t.onLoaded(c,{url:a,label:i})}catch(l){this.logMessage("warn",`[LandmarkManager] onLoaded hook failed for ${r}: ${l?.message||l}`)}return{object:c,url:a}}catch(c){this.logMessage("warn",`[LandmarkManager] ${r} failed to load from ${a}${i==="fallback"?" (fallback)":""}`),this.logMessage("warn",c)}}return null}async placeLandmark(e={}){e.name||e.id;const t=this.prepareTransform(e),n=this.resolveUrls(e.assetFiles||[]),i=this.resolveUrls(e.fallbackFiles||[]),r=e.messages||{};!n.length&&r.missingPrimary&&!this.quietMissing&&this.logMessage("info",r.missingPrimary);let a=await this.attemptLoad(n,e,t,"primary");if(!a&&i.length){r.missingPrimary&&!this.quietMissing&&this.logMessage("info",r.missingPrimary);const o=await this.attemptLoad(i,e,t,"fallback");o?(r.fallbackUsed&&!this.quietMissing&&this.logMessage("info",r.fallbackUsed),a=o):r.fallbackMissing&&!this.quietMissing&&this.logMessage("warn",r.fallbackMissing)}return a||(!i.length&&r.allMissing&&!this.quietMissing&&this.logMessage("info",r.allMissing),this.spawnFallbackPlaceholder(e,t)),a?.object??null}async loadConfig(e){if(!e)return[];this.globalDefaults=na(e.defaults),this.results=[];const t=Array.isArray(e.groups)?e.groups:[];for(const n of t){if(n?.enabled===!1)continue;const i=na(this.globalDefaults,n?.defaults),r=Array.isArray(n?.landmarks)?n.landmarks:[];for(const a of r){if(a?.enabled===!1)continue;const o=na(i,a);o.groupId=n?.id,o.groupLabel=n?.label;const c=await this.placeLandmark(o);this.results.push({spec:o,object:c})}}return e.metadata?.description?this.logMessage("info",`[LandmarkManager] Loaded ${this.results.length} landmarks: ${e.metadata.description}`):this.logMessage("info",`[LandmarkManager] Loaded ${this.results.length} landmarks.`),this.results}}function $t(s,e={}){const t=s||{x:0,y:0,z:0},n=e.x??e[0]??0,i=e.y??e[1]??0,r=e.z??e[2]??0;return{x:(t.x??0)+n,y:(t.y??0)+i,z:(t.z??0)+r}}const bB={version:1,metadata:{author:"configuration",description:"Historic Athens layout covering the Acropolis, Agora, and civic outskirts."},defaults:{collision:!1,alignToTerrain:!0,surfaceOffset:.08,snapOptions:{clampToSea:!0,minAboveSea:.05},placeholder:{enabled:!0},loadOptions:{materialPreset:"marble"}},landmarks:{poseidon:["models/buildings/poseidon_temple_at_sounion_greece.glb","models/landmarks/poseidon_temple.glb","models/landmarks/poseidon_temple_at_sounion_greece.glb"],akropol:["models/buildings/Akropol.glb","models/landmarks/akropol.glb","models/landmarks/Akropol.glb"],aristotle:["models/buildings/aristotle_tomb_in_macedonia_greece.glb","models/landmarks/aristotle_tomb.glb","models/landmarks/aristotle_tomb_in_macedonia_greece.glb"]},groups:[{id:"acropolis-plateau",label:"Acropolis Plateau",description:"Monuments crowning the limestone plateau dedicated to Athena.",defaults:{collision:!0},landmarks:[{id:"parthenon",enabled:!1,name:"Parthenon",description:"Periklean temple celebrating Athena Parthenos, rebuilt after the Persian Wars.",assetFiles:["models/buildings/Akropol.glb"],placement:{position:$t(rn,{x:6,z:-6}),rotation:{y:Math.PI*.22},scale:.45,surfaceOffset:.18,snapOptions:{minAboveSea:.5}},messages:{missingPrimary:"Parthenon asset missing – add models/buildings/Akropol.glb to restore the plateau model."}},{id:"erechtheion",enabled:!1,name:"Erechtheion",description:"Split-level shrine to Athena Polias and Poseidon-Erechtheus with caryatid porch.",assetFiles:["models/landmarks/erechtheion.glb"],fallbackFiles:["models/buildings/Akropol.glb"],placement:{position:$t(rn,{x:-4,z:4}),rotation:{y:Math.PI*.65},scale:.25},placeholder:{accentColor:13350814},messages:{missingPrimary:"Erechtheion model not found. Drop a GLB at public/models/landmarks/erechtheion.glb to replace the placeholder.",fallbackUsed:"Erechtheion is temporarily using the Acropolis shell as a stand-in."}},{id:"athena-nike",enabled:!1,name:"Temple of Athena Nike",description:"Compact bastion temple guarding the western entrance to the sanctuary.",assetFiles:["models/landmarks/temple_athena_nike.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(rn,{x:-14,z:-8}),rotation:{y:-Math.PI*.12},scale:.16,surfaceOffset:.12},placeholder:{accentColor:14140839,baseRadius:1.8},messages:{missingPrimary:"Temple of Athena Nike model missing – add models/landmarks/temple_athena_nike.glb to restore it.",fallbackUsed:"Temple of Athena Nike currently reuses the Poseidon temple asset as a stand-in."}},{id:"propylaea",enabled:!1,name:"Propylaea",description:"Monumental gateway framing the ascent to the Acropolis plateau.",assetFiles:["models/landmarks/propylaea.glb"],fallbackFiles:["models/buildings/Akropol.glb"],placement:{position:$t(rn,{x:-16,z:-10}),rotation:{y:-Math.PI*.35},scale:.3,surfaceOffset:.14},messages:{missingPrimary:"Propylaea model missing – supply public/models/landmarks/propylaea.glb to restore the gateway."}},{id:"brauronia",enabled:!1,name:"Sanctuary of Artemis Brauronia",description:"Shrine and stoa nestled along the southern flank of the Parthenon.",assetFiles:["models/landmarks/brauronia.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(rn,{x:-2,z:-2}),rotation:{y:Math.PI*.08},scale:.22},placeholder:{accentColor:13808524},messages:{missingPrimary:"Sanctuary of Artemis Brauronia missing – place brauronia.glb under public/models/landmarks/."}},{id:"athena-promachos",name:"Athena Promachos",description:"Colossal bronze of Athena guarding the sanctuary, visible from the sea.",assetFiles:["models/landmarks/athena_promachos.glb"],fallbackFiles:["models/landmarks/erechtheion.glb","models/buildings/Akropol.glb"],placement:{position:$t(rn,{x:2,z:2}),rotation:{y:Math.PI*.5},scale:.14,surfaceOffset:.1},loadOptions:{materialPreset:"bronze"},placeholder:{accentColor:10775868},messages:{missingPrimary:"Athena Promachos statue missing – add athena_promachos.glb for a bespoke bronze model."}}]},{id:"acropolis-slopes",label:"Acropolis Slopes",description:"Performance venues and healing sanctuaries hugging the southern cliffs.",defaults:{collision:!0},landmarks:[{id:"theatre-dionysus",enabled:!1,name:"Theatre of Dionysus",description:"Birthplace of Attic drama hosting the City Dionysia festival.",assetFiles:["models/landmarks/theatre_dionysus.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(rn,{x:12,z:18}),rotation:{y:Math.PI*.65},scale:.5,surfaceOffset:.06},placeholder:{baseRadius:3.6,columnHeight:3.6},messages:{missingPrimary:"Theatre of Dionysus model missing – place theatre_dionysus.glb under public/models/landmarks/."}},{id:"odeon-herodes-atticus",enabled:!1,name:"Odeon of Herodes Atticus",description:"Roman-era odeon providing sheltered concerts along the south-west slope.",assetFiles:["models/landmarks/odeon_herodes_atticus.glb"],fallbackFiles:["models/landmarks/theatre_dionysus.glb"],placement:{position:$t(rn,{x:-14,z:20}),rotation:{y:-Math.PI*.22},scale:.46},messages:{missingPrimary:"Odeon of Herodes Atticus model missing – add odeon_herodes_atticus.glb to supply the odeon interior."}},{id:"asclepieion",enabled:!1,name:"Sanctuary of Asclepius",description:"Healing precinct with fountain, temple, and incubation hall.",assetFiles:["models/landmarks/asclepieion.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(rn,{x:-6,z:16}),rotation:{y:Math.PI*.4},scale:.28},messages:{missingPrimary:"Sanctuary of Asclepius model missing – provide asclepieion.glb to restore the healing complex."}},{id:"stoa-eumenes",enabled:!1,name:"Stoa of Eumenes",description:"Covered promenade linking the Theatre of Dionysus to the Odeon.",assetFiles:["models/landmarks/stoa_eumenes.glb"],fallbackFiles:["models/landmarks/odeon_herodes_atticus.glb"],placement:{position:$t(rn,{x:-10,z:22}),rotation:{y:Math.PI*.1},scale:.42},messages:{missingPrimary:"Stoa of Eumenes model missing – drop stoa_eumenes.glb into public/models/landmarks/."}}]},{id:"athenian-agora",label:"Athenian Agora",description:"Civic square hosting the council, courts, and bustling stoas of democratic Athens.",defaults:{collision:!0},landmarks:[{id:"temple-hephaestus",enabled:!1,name:"Temple of Hephaestus",description:"Doric temple overlooking the Agora, dedicated to Hephaestus and Athena Ergane.",assetFiles:["models/landmarks/temple_hephaestus.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(Gt,{x:-6,z:-6}),rotation:{y:Math.PI*.25},scale:.38,surfaceOffset:.1},messages:{missingPrimary:"Temple of Hephaestus missing – add temple_hephaestus.glb under public/models/landmarks/.",fallbackUsed:"Temple of Hephaestus currently reuses the Poseidon temple asset."}},{id:"stoa-attalos",enabled:!1,name:"Stoa of Attalos",description:"Two-storey stoa rebuilt by Attalos II as a bustling market frontage.",assetFiles:["models/landmarks/stoa_attalos.glb"],fallbackFiles:["models/buildings/Akropol.glb"],placement:{position:$t(Gt,{x:4,z:6}),rotation:{y:-Math.PI*.45},scale:.46},messages:{missingPrimary:"Stoa of Attalos model missing – include stoa_attalos.glb to complete the eastern colonnade."}},{id:"bouleuterion",enabled:!1,name:"Bouleuterion",description:"Council chamber where the 500 met to prepare proposals for the Assembly.",assetFiles:["models/landmarks/bouleuterion.glb"],fallbackFiles:["models/landmarks/stoa_attalos.glb"],placement:{position:$t(Gt,{x:-2,z:0}),rotation:{y:Math.PI*.15},scale:.26},messages:{missingPrimary:"Bouleuterion model missing – add bouleuterion.glb so the council house appears in game."}},{id:"tholos",enabled:!1,name:"Tholos",description:"Round building housing the prytaneis and the city’s official weights and measures.",assetFiles:["models/landmarks/tholos.glb"],fallbackFiles:["models/landmarks/bouleuterion.glb"],placement:{position:$t(Gt,{x:-4,z:4}),rotation:{y:Math.PI*.5},scale:.18},messages:{missingPrimary:"Tholos model missing – add tholos.glb to represent the prytaneis headquarters."}},{id:"eponymous-heroes",enabled:!1,name:"Monument of the Eponymous Heroes",description:"Display platform for tribal hero statues and civic announcements.",assetFiles:["models/landmarks/eponymous_heroes.glb"],fallbackFiles:["models/landmarks/tholos.glb"],placement:{position:$t(Gt,{x:6,z:2}),rotation:{y:-Math.PI*.2},scale:.2},messages:{missingPrimary:"Eponymous Heroes monument missing – include eponymous_heroes.glb for the notice board."}},{id:"royal-stoa",enabled:!1,name:"Royal Stoa",description:"Law court of the archon basileus at the north-western edge of the Agora.",assetFiles:["models/landmarks/royal_stoa.glb"],fallbackFiles:["models/landmarks/stoa_attalos.glb"],placement:{position:$t(Gt,{x:2,z:-4}),rotation:{y:Math.PI*.05},scale:.28},messages:{missingPrimary:"Royal Stoa model missing – add royal_stoa.glb to depict the archon basileus' court."}}]},{id:"city-outskirts",label:"City & Outskirts",description:"Religious sanctuaries and athletic venues beyond the civic core.",defaults:{collision:!0},landmarks:[{id:"temple-olympian-zeus",enabled:!1,name:"Temple of Olympian Zeus",description:"Gigantic Corinthian temple southeast of the Acropolis, finished under Hadrian.",assetFiles:["models/landmarks/temple_olympian_zeus.glb"],fallbackFiles:["models/buildings/poseidon_temple_at_sounion_greece.glb"],placement:{position:$t(rn,{x:24,z:44}),rotation:{y:Math.PI*.1},scale:.62},messages:{missingPrimary:"Temple of Olympian Zeus model missing – provide temple_olympian_zeus.glb for the colossal sanctuary."}},{id:"panathenaic-stadium",enabled:!1,name:"Panathenaic Stadium",description:"U-shaped track refurbished in marble for the Panathenaic Games.",assetFiles:["models/landmarks/panathenaic_stadium.glb"],fallbackFiles:["models/landmarks/theatre_dionysus.glb"],placement:{position:$t(rn,{x:40,z:72}),rotation:{y:Math.PI*.9},scale:.9,surfaceOffset:.04},messages:{missingPrimary:"Panathenaic Stadium model missing – add panathenaic_stadium.glb to showcase the racecourse."}},{id:"academy-plato",enabled:!1,name:"Academy of Plato",description:"Grove and gymnasium northwest of the city where Plato taught philosophy.",assetFiles:["models/landmarks/academy_plato.glb"],fallbackFiles:["models/landmarks/royal_stoa.glb"],placement:{position:$t(Gt,{x:-30,z:24}),rotation:{y:Math.PI*.3},scale:.32},messages:{missingPrimary:"Academy of Plato model missing – add academy_plato.glb to represent the sacred grove."}},{id:"kerameikos",enabled:!1,name:"Kerameikos & Dipylon Gate",description:"Potters’ quarter and cemetery guarding the Sacred Way into the city.",assetFiles:["models/landmarks/kerameikos.glb"],fallbackFiles:["models/landmarks/academy_plato.glb"],placement:{position:$t(Gt,{x:-24,z:-30}),rotation:{y:-Math.PI*.15},scale:.4},messages:{missingPrimary:"Kerameikos model missing – drop kerameikos.glb into public/models/landmarks/ for the Dipylon Gate."}}]}]},jc=new Map;async function xB(s){if(typeof s!="string"||s.length===0)return!1;if(jc.has(s))return jc.get(s);try{const e=await fetch(s,{method:"HEAD"}),t=e.ok&&!(e.headers.get("content-type")||"").includes("text/html");return jc.set(s,t),t}catch{return jc.set(s,!1),!1}}async function xs(s,e,{isSRGB:t=!1}={}){if(typeof e!="string"||e.length===0)return null;const n=xt(e),i=Array.from(new Set([n,n.replace("basecolor","albedo").replace("gravel/","gravel_path-")].filter(Boolean))),r=["webp","jpg","png"],a=Hn();for(const o of i)for(const c of r){const l=`${o}.${c}`,h=xt(a,l);if(!await xB(h))continue;const u=await s.loadAsync(h);if(u&&t&&(u.colorSpace=Bt),u)return u}return null}async function _B(s){const e=new Da,t=await xs(e,xt(s,"basecolor"),{isSRGB:!0});if(!t)return null;const n=await xs(e,xt(s,"normal")),i=await xs(e,xt(s,"roughness")),r=await xs(e,xt(s,"ao"));return new tt({map:t,normalMap:n||void 0,roughnessMap:i||void 0,aoMap:r||void 0,metalness:0,roughness:1})}async function EB(s,e=[6,6]){const t=new Da,n=await xs(t,xt(s,"basecolor"),{isSRGB:!0});if(!n)return null;const i=await xs(t,xt(s,"normal")),r=await xs(t,xt(s,"roughness")),a=await xs(t,xt(s,"ao")),o=[n,i,r,a].filter(Boolean);for(const l of o)l.wrapS=l.wrapT=zn,l.repeat.set(e[0],e[1]);return new tt({map:n,normalMap:i||void 0,roughnessMap:r||void 0,aoMap:a||void 0,metalness:0,roughness:1,polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:-1})}function vB(s,e){!s||!e||s.traverse(t=>{t&&t.isMesh&&(t.material=e,t.geometry?.attributes?.color&&(t.material.vertexColors=!0))})}async function wB(s){const{obj:e=null,scene:t,renderer:n,BASE_URL:i="",baseUrl:r=i,textureSubdir:a="textures/aristotle_tomb",approxPosition:o=new C(-40,14,10)}=s||{};n&&(n.outputColorSpace||(n.outputColorSpace=Bt),(n.toneMapping===void 0||n.toneMapping===Ni)&&(n.toneMapping=zl,n.toneMappingExposure=n.toneMappingExposure??1));const c=typeof r=="string"&&r.length>0?r:Hn(),l=xt(c,os(a)),h=await _B(l);if(!h)return;let u=e;if(!u&&t){let d=null,f=1/0;const A=new C;t.traverse(g=>{if(g?.isObject3D&&(g.isMesh||g.isGroup)){g.getWorldPosition(A);const m=A.distanceToSquared(o);m<f&&(f=m,d=g)}}),u=d||null}u&&vB(u,h)}async function SB({scene:s,baseUrl:e,repeat:t=[6,6]}={}){if(!s)return;const n=typeof e=="string"&&e.length>0?e:Hn(),i=xt(n,"textures/gravel"),r=await EB(i,t);if(!r)return;const a=o=>{const c=(o.name||"").toLowerCase(),l=o.userData||{};return c.includes("road")||c.includes("street")||c.includes("path")||l.type==="road"||l.kind==="road"||l.category==="road"};s.traverse(o=>{o?.isMesh&&a(o)&&(o.material&&o.material.userData?.__isGravel||(o.material=r,o.material.userData={...o.material.userData||{},__isGravel:!0},o.receiveShadow=!0))})}const CB={},hm="WorldRoot",MB=!0,um={dawn:{phase:.25,exposure:.9,label:"Dawn",hotkey:"1"},noon:{phase:.5,exposure:1.5,label:"High Noon",hotkey:"2"},dusk:{phase:.75,exposure:.95,label:"Dusk",hotkey:"3"},night:{phase:0,exposure:.6,label:"Night",hotkey:"4"}};window.addEventListener("unhandledrejection",s=>{console.error("Unhandled promise rejection:",s.reason)});const $i=Hn(),dm=["models/buildings/aristotle_tomb.glb","models/buildings/aristotle_tomb_in_macedonia_greece.glb","models/landmarks/aristotle_tomb.glb","models/landmarks/aristotle_tomb_in_macedonia_greece.glb","aristotle_tomb_in_macedonia_greece.glb"],IB=["models/buildings/poseidon_temple.glb","models/buildings/poseidon_temple_at_sounion_greece.glb","models/landmarks/poseidon_temple.glb","models/landmarks/poseidon_temple_at_sounion_greece.glb","poseidon_temple_at_sounion_greece.glb"],TB=["models/buildings/akropol.glb","models/buildings/Akropol.glb","models/landmarks/akropol.glb","models/landmarks/Akropol.glb","Akropol.glb"],BB=s=>(s.headers.get("content-type")||"").includes("text/html");async function xd(s){try{const e=await fetch(s,{method:"HEAD"});return e.ok&&!BB(e)}catch{return!1}}async function Vu(s=[]){const e=new Set;for(const t of s){if(typeof t!="string")continue;const n=t.trim();if(!n)continue;if(/^(?:[a-z]+:)?\/\//i.test(n)){if(!e.has(n)&&await xd(n))return n;e.add(n);continue}const i=os(n);if(!i)continue;const r=Array.from(new Set([xt($i,i),i].filter(Boolean)));for(const a of r)if(!e.has(a)&&(e.add(a),await xd(a)))return a}throw new Error("No candidate asset reachable: "+s.join(", "))}async function RB(){const s=Hn(),e=[{label:"Audio Manifest",path:xt(s,"audio/manifest.json")},{label:"Aristotle Tomb",path:xt(s,"models/landmarks/aristotle_tomb.glb")},{label:"District Rules",path:xt(s,"config/districts.json")},{label:"Water Normals",path:xt(s,"textures/ground/water_normals.png")}],t=[];for(const{label:n,path:i}of e){const r=await xd(i);t.push({label:n,path:i,status:r?"ok":"missing"})}typeof console?.table=="function"?console.table(t,["label","path","status"]):console.log("Asset QuickChecks",t)}function DB(s){s&&(s.shadowMap.enabled=!0,s.shadowMap.type=Ed,s.shadowMap&&(s.shadowMap.autoUpdate=!0,s.shadowMap.needsUpdate=!0))}function Zc(s,e,t=0){const n=Math.sin(s*127.1+e*311.7+t*74.7)*43758.5453;return n-Math.floor(n)}function PB(s,e,t=0){const n=Math.floor(s),i=Math.floor(e),r=s-n,a=e-i,o=Zc(n,i,t),c=Zc(n+1,i,t),l=Zc(n,i+1,t),h=Zc(n+1,i+1,t),u=r*r*(3-2*r),d=a*a*(3-2*a),f=ue.lerp(o,c,u),A=ue.lerp(l,h,u);return ue.lerp(f,A,d)}function Wu(s,e,{seed:t=0,octaves:n=5,persistence:i=.5,lacunarity:r=2}={}){let a=0,o=1,c=1;for(let l=0;l<n;l+=1)a+=o*PB(s*c,e*c,t+l*19.19),o*=i,c*=r;return a}let ta=null;function $c(s,{colorSpace:e=Bt}={}){const t=new Uint8Array(4);t[0]=s>>16&255,t[1]=s>>8&255,t[2]=s&255,t[3]=255;const n=new Kn(t,1,1,zt);return n.colorSpace=e,n.wrapS=n.wrapT=zn,n.repeat.set(3,3),n.needsUpdate=!0,n}function yy(){if(ta)return ta;if(typeof document>"u"||!document.createElement)return ta={map:$c(15723754,{colorSpace:Bt}),normalMap:$c(8421631,{colorSpace:kt}),roughnessMap:$c(11776947,{colorSpace:kt}),aoMap:$c(14737632,{colorSpace:kt})},ta;const s=512,e=document.createElement("canvas");e.width=s,e.height=s;const t=e.getContext("2d"),n=t.createImageData(s,s),i=t.createImageData(s,s),r=t.createImageData(s,s),a=t.createImageData(s,s),o=new Float32Array(s*s),c=6;for(let d=0;d<s;d+=1)for(let f=0;f<s;f+=1){const A=(d*s+f)*4,g=f/s*c,m=d/s*c,p=Wu(g*.85,m*.9,{seed:11,octaves:4}),x=Wu(g*2.3,m*2.4,{seed:37,octaves:5,persistence:.55,lacunarity:2.15}),b=g*1.12+m*1.27+x*4.2,y=Math.sin(b+p*2.6),_=Wu(g*5.2,m*5.4,{seed:73,octaves:3,persistence:.6,lacunarity:2.8}),w=.5+.5*y*.8+_*.2,S=Math.pow(Math.abs(Math.sin(b*.6+_*3.4)),1.4);o[d*s+f]=w;const M=.04+p*.03,v=ue.clamp(.78+w*.18+p*.05,0,1);let E=v+M,B=v+M*.6,D=v+M*.2;E=ue.clamp(E-S*.09,0,1),B=ue.clamp(B-S*.07,0,1),D=ue.clamp(D-S*.05,0,1),n.data[A+0]=Math.round(E*255),n.data[A+1]=Math.round(B*255),n.data[A+2]=Math.round(D*255),n.data[A+3]=255;const F=ue.clamp(.42+S*.32+_*.12,.18,.88),N=Math.round(F*255);i.data[A+0]=N,i.data[A+1]=N,i.data[A+2]=N,i.data[A+3]=255;const O=ue.clamp(.93-S*.35-_*.18,.45,1),k=Math.round(O*255);r.data[A+0]=k,r.data[A+1]=k,r.data[A+2]=k,r.data[A+3]=255}const l=(d,f)=>{const A=(d+s)%s,g=(f+s)%s;return o[g*s+A]},h=2.1;for(let d=0;d<s;d+=1)for(let f=0;f<s;f+=1){const A=(d*s+f)*4,g=l(f-1,d),m=l(f+1,d),p=l(f,d-1),x=l(f,d+1),b=(m-g)*h,y=(x-p)*h,_=1,w=Math.sqrt(b*b+y*y+_*_)||1,S=b/w,M=y/w,v=_/w;a.data[A+0]=Math.round((S*.5+.5)*255),a.data[A+1]=Math.round((M*.5+.5)*255),a.data[A+2]=Math.round((v*.5+.5)*255),a.data[A+3]=255}const u=(d,{colorSpace:f})=>{const A=document.createElement("canvas");A.width=s,A.height=s,A.getContext("2d").putImageData(d,0,0);const m=new Ag(A);return m.wrapS=m.wrapT=zn,m.repeat.set(3,3),m.anisotropy=4,m.colorSpace=f,m.needsUpdate=!0,m};return ta={map:u(n,{colorSpace:Bt}),normalMap:u(a,{colorSpace:kt}),roughnessMap:u(i,{colorSpace:kt}),aoMap:u(r,{colorSpace:kt})},ta}const LB=new Set(["","1","true","on","yes","y"]),FB=new Set(["0","false","off","no","n"]);function Ql(s,e=!0){if(s==null)return e;const t=String(s).trim().toLowerCase();return LB.has(t)?!0:FB.has(t)?!1:e}function UB({queryKey:s,windowFlagKey:e,defaultValue:t=!0,devDefault:n=!0}={}){if(typeof window>"u")return t;if(s){const i=new URLSearchParams(window.location.search);if(i.has(s))return Ql(i.get(s),t)}if(e&&typeof window[e]<"u"){const i=window[e];return typeof i=="boolean"?i:Ql(i,t)}return t}function NB(s={}){const e=s.minutesPerDay??20,n=(Number.isFinite(e)?Math.max(0,e):0)*60;return{secondsPerDay:n,phaseAt(i=0){return!Number.isFinite(i)||n<=0?0:(i%n+n)%n/n}}}async function kB(){console.log("🔧 Athens mainApp start"),RB().catch(H=>{console.warn("Asset QuickChecks failed",H)});const s=new o0({antialias:!0});s.outputColorSpace=Bt,s.toneMapping=zl,s.toneMappingExposure=1,s.useLegacyLights=!1,s.localClippingEnabled=!0,DB(s),s.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(s.domElement),!(typeof import.meta<"u"&&CB)&&iB(s,{min:.2,max:2,step:.01,key:"F9"}),y1(s),JC(),oB({toggleKey:"KeyH"});const t=document.createElement("div");t.textContent="Press E to interact",Object.assign(t.style,{position:"fixed",left:"50%",bottom:"20%",transform:"translateX(-50%)",padding:"8px 12px",borderRadius:"6px",background:"rgba(0, 0, 0, 0.6)",color:"#fff",fontFamily:"sans-serif",fontSize:"14px",letterSpacing:"0.05em",opacity:"0",transition:"opacity 0.2s ease",pointerEvents:"none"}),document.body.appendChild(t);const n=document.createElement("div");Object.assign(n.style,{position:"fixed",right:"16px",bottom:"16px",padding:"6px 10px",borderRadius:"6px",background:"rgba(0, 0, 0, 0.6)",color:"#fff",fontFamily:"sans-serif",fontSize:"14px",letterSpacing:"0.05em",pointerEvents:"none",textTransform:"uppercase"}),document.body.appendChild(n);function i(H=0){const ye=Math.max(0,Math.min(1,H))*24*60,Ke=Math.floor(ye/60)%24,gt=Math.floor(ye%60);return`${Ke.toString().padStart(2,"0")}:${gt.toString().padStart(2,"0")}`}let r="";const a=new Pd;a.userData=a.userData||{},a.userData.renderer=s,a.userData.baseUrl=$i;const o=H=>{if(!H)return;const ye=Array.isArray(H)?H:[H];for(const Ke of ye)if(Ke){for(const gt of Object.values(Ke))gt&&gt.isTexture&&typeof gt.dispose=="function"&&gt.dispose();typeof Ke.dispose=="function"&&Ke.dispose()}},c=H=>{H&&H.traverse(ye=>{ye.isMesh&&(ye.geometry&&typeof ye.geometry.dispose=="function"&&ye.geometry.dispose(),o(ye.material))})},l=H=>{if(!H)return;const ye=[...H.children];for(const Ke of ye)c(Ke),H.remove(Ke)},h=()=>{const H=a.userData?.worldRoot??a.getObjectByName(hm);H&&(l(H),H.parent?.remove(H));const ye=new _t;return ye.name=hm,ye.userData=ye.userData||{},ye.userData.renderer=a.userData?.renderer||null,typeof a.userData?.baseUrl=="string"?ye.userData.baseUrl=a.userData.baseUrl:delete ye.userData.baseUrl,a.add(ye),a.userData.worldRoot=ye,ye};a.fog=new Fo(10526880,50,400);const u=new en(75,window.innerWidth/window.innerHeight,.1,2e3);u.position.set(0,5,10);const d=kC(a),f=XC(a),A=new PC(a,u,{getNightFactor:()=>f.nightFactor},{harbor:bn,agora:Gt,acropolis:rn});let g=!1;await A.loadManifest("audio/manifest.json").catch(()=>{g=!0,console.info("[audio] No audio manifest found; running silently.")}),await A.initFromManifest("audio/manifest.json"),await A.ensureUserGestureResume(),UB({queryKey:"audio",windowFlagKey:"SHOW_AUDIO_MIXER"})&&UC(A);const p=QC(a,1e3),x=YC(a),b=kM(a);if(fB(b),a.userData.terrain=b,a.userData.getHeightAt=b?.userData?.getHeightAt,typeof b?.userData?.getHeightAt=="function"&&(a.userData.terrainHeightSampler=b.userData.getHeightAt),(()=>{try{const H=new URLSearchParams(window.location.search);if(H.has("occluder")){const ye=H.get("occluder");return ye===null||ye===""||ye==="1"||ye==="true"||ye==="on"}}catch{}return!1})()){const H=new $(-.4,-.3),ye=new $(-95.7,-3.1);pB(a,b,H,ye,6,140)}const _=(()=>{if(typeof window>"u")return!1;try{const H=new URLSearchParams(window.location.search);return H.has("grass")?Ql(H.get("grass"),!1):!1}catch(H){return console.warn("Failed to parse grass flag from query string:",H),!1}})(),w=await JM(a,{bounds:il}),S=eI(a,{center:bn}),M=new L1;a.add(M.mesh);const v=h();let E=null;const B=(()=>{if(typeof window>"u")return!0;try{const H=new URLSearchParams(window.location.search);return H.has("roads")?Ql(H.get("roads"),!0):!0}catch(H){return console.warn("Failed to parse roads visibility from query string:",H),!0}})(),{group:D,curve:F}=tI(v,b);D&&(D.visible=B),_&&(E=$I(a),E&&Su(f.nightFactor));try{const H=await Vu(dm);if(H){const ye=await al(v,H,{position:rn,scale:3,materialPreset:"marble"});try{await wB({obj:ye??null,scene:a,renderer:s,BASE_URL:$i})}catch(Ke){console.warn("Aristotle PBR hook skipped:",Ke)}}else console.warn("Aristotle's Tomb not found. Expected at:",dm)}catch(H){console.error("Failed to load Aristotle's Tomb:",H)}try{const H=await Vu(IB);H&&await al(v,H,{position:new C(90,0,-60),scale:2.6,materialPreset:"marble"})}catch(H){console.warn("Poseidon Temple not loaded:",H)}try{const H=await Vu(TB);H&&await al(v,H,{position:new C(130,0,40),scale:2.2,materialPreset:"marble"})}catch(H){console.warn("Akropol not loaded:",H)}const N=await II(v,b,{roadsVisible:B}),O=TI(v,b,F,{seed:42,buildingCount:140});try{await SB({scene:a,baseUrl:$i,repeat:[6,6]})}catch(H){console.warn("Gravel roads hook skipped:",H)}M.fromStaticScene(a);const k=C1(v,{plazaLength:90,promenadeWidth:16,greensWidth:9,center:Gt,terrain:b});M.refresh();const q=new P1(s.domElement),U=new O1(q,M,{camera:u});v.add(U.object);const te=new C(0,0,10);U.object.position.copy(te);const re=U.height*.5+.1;gd(U.object,b,te.x,te.z,re,{clampToSea:!0,seaLevel:ot,minAboveSea:.25}),U.syncCapsuleToObject();let Ce=null;const Ue=[];M?.mesh&&Ue.push(M.mesh),b&&Ue.push(b);const at=new C(0,U.height*.6,0);let Qe=null,K=!1;const J={active:!1,pointerId:null,lastX:0,lastY:0,pendingUse:!1,pointerType:null};let Ee=!1;const Re=s.domElement,ke=1.5,st=()=>{if(J.pointerId!==null)try{Re.releasePointerCapture(J.pointerId)}catch{}J.active=!1,J.pointerId=null,J.pendingUse=!1,J.pointerType=null},vt=H=>{if(!(!K||!Qe)&&H.isPrimary&&!(H.pointerType!=="touch"&&H.button!==0)){J.active=!0,J.pointerId=H.pointerId,J.lastX=H.clientX,J.lastY=H.clientY,J.pointerType=H.pointerType,J.pendingUse=H.button===0||H.pointerType==="touch";try{Re.setPointerCapture(H.pointerId)}catch{}H.preventDefault()}},P=H=>{if(!J.active||J.pointerId!==H.pointerId)return;const ye=H.clientX-J.lastX,Ke=H.clientY-J.lastY;J.lastX=H.clientX,J.lastY=H.clientY,(Math.abs(ye)>ke||Math.abs(Ke)>ke)&&(J.pendingUse=!1),Qe&&Qe.handlePointer(ye,Ke),H.preventDefault()},de=H=>{if(J.pointerId!==H.pointerId)return;const ye=J.pendingUse&&(H.button===0||J.pointerType==="touch");st(),ye&&Ce&&Ce.useObject(),H.preventDefault()},ie=()=>{J.active&&st()},se=()=>{Ee||(Ee=!0,Re.addEventListener("pointerdown",vt),Re.addEventListener("pointermove",P),Re.addEventListener("pointerup",de),Re.addEventListener("pointercancel",ie),Re.addEventListener("lostpointercapture",ie),window.addEventListener("blur",ie))},ne=()=>{Ee&&(Ee=!1,Re.removeEventListener("pointerdown",vt),Re.removeEventListener("pointermove",P),Re.removeEventListener("pointerup",de),Re.removeEventListener("pointercancel",ie),Re.removeEventListener("lostpointercapture",ie),window.removeEventListener("blur",ie),st())},xe=H=>{if(!Qe)return;const ye=!!H;if(K!==ye)if(K=ye,Qe.setEnabled(ye),ye){if(Qe.setAngles(U.cameraYaw??0,U.cameraPitch??0,{snap:!0}),Qe.update(0),se(),typeof document<"u"&&document.pointerLockElement===Re&&typeof document.exitPointerLock=="function")try{document.exitPointerLock()}catch{}}else Qe.setAngles(U.cameraYaw??0,U.cameraPitch??0,{snap:!0}),ne()};Qe=new Z1(u,U.object,{targetOffset:at,followLerp:.12,rotationLerp:.15,solids:Ue,enabled:!1,keyOrbit:{enabled:!0,yawSpeed:.9,pitchSpeed:.9,minPitch:-.6,maxPitch:.6,minDist:2.5,maxDist:7.5,zoomSpeed:4}});const le=new _t;le.name="DemoDoor",le.position.set(-2,0,-12);const ve=new Ut(1.2,2.4,.12),nt=new tt({color:5911312}),Ze=new Be(ve,nt);Ze.position.set(.6,1.2,0),Ze.castShadow=!0,Ze.receiveShadow=!0,le.add(Ze),le.userData.interactable=!0,le.userData.highlightTarget=Ze,le.userData.open=!1,le.userData.onUse=H=>{const ye=!H.userData.open;H.userData.open=ye,Ze.rotation.y=ye?-Math.PI/2:0,console.log(`Door ${ye?"opened":"closed"}`)},v.add(le);const R=new _t;R.name="DemoLamp",R.position.set(2,0,-12);const T=new Lt(.1,.1,3,12),W=new tt({color:3158064}),X=new Be(T,W);X.position.y=1.5,X.castShadow=!1,R.add(X);const he=new tt({color:2236962,emissive:new oe(16774581),emissiveIntensity:1.5}),j=new Be(new Jn(.25,16,16),he);j.position.y=3,j.castShadow=!1,R.add(j);const Ge=new ss(16774581,1.5,12,2);Ge.position.y=3,Ge.castShadow=!1,R.add(Ge),R.userData.interactable=!0,R.userData.highlightTarget=j,R.userData.light=Ge,R.userData.onUse=H=>{const ye=H.userData.light;if(!ye)return;const Ke=ye.intensity>.1;ye.intensity=Ke?0:1.5,he.emissiveIntensity=Ke?0:1.5,console.log(`Lamp ${Ke?"turned off":"turned on"}`)},v.add(R);const we=()=>{const H=new _t;H.name="FallbackAvatar";const ye=new tt({color:5148407,metalness:.2,roughness:.6}),Ke=new Be(new Lt(.35,.35,1.2,16),ye);Ke.castShadow=!0,Ke.receiveShadow=!0,Ke.position.y=.6,H.add(Ke);const gt=new Be(new Jn(.32,16,16),new tt({color:16054271,roughness:.4}));return gt.castShadow=!0,gt.position.y=1.32,H.add(gt),H},Ve=()=>{U.character&&(c(U.character),U.object.remove(U.character),U.character=void 0);const H=U.object.children.find(ye=>ye.name==="FallbackAvatar");H&&(c(H),U.object.remove(H))},He=new py,Ae=xt($i,"models/character/hero.glb"),Fe="models/character/hero.glb",et=encodeURIComponent("astronaut.glb"),Ye=xt($i,"models/character",et),De=xt("models/character",et),ct=()=>{Ve();const H=we();U.object.add(H),H.position.set(0,0,0)},G=Array.from(new Set([Ae,Fe,Ye,De].filter(Boolean)));try{const H=ly(s),ye=await df(H,G,{renderer:s,targetHeight:1.8});if(!ye||!ye.root)throw new Error("No hero GLB candidates reachable");const{url:Ke,gltf:gt,root:Z}=ye;Ve(),He.initializeFromGLTF(Z,gt.animations),U.attachCharacter(He),Ke!==Ae&&Ke!==Fe&&console.info(`Hero GLB not found at ${Ae}; using bundled astronaut sample from ${Ke}.`),console.log("[Hero] Loaded:",Ke)}catch(H){console.error("[Hero] All candidates failed, using fallback avatar:",H?.message||H),console.info(`Add your own hero model at ${Ae}; the bundled astronaut sample will load otherwise.`),ct()}const be=new N1(M),_e=b?.userData?.getHeightAt;a.userData=a.userData||{},a.userData.terrain||(a.userData.terrain=b),typeof _e=="function"&&(a.userData.terrainHeightSampler=_e,typeof a.userData.getHeightAt!="function"&&(a.userData.getHeightAt=_e)),be.clearBuildings(),E1();const Oe=new _t;Oe.name="BuildingsRoot",v.add(Oe);const me=[];if(k.walkingLoop){const H=tB(v,k.walkingLoop,{count:8,minSpeed:.7,maxSpeed:1.4,terrain:b});me.push(...H.updaters)}nB(v,F,{terrain:b}).then(H=>{H&&Array.isArray(H.updaters)&&me.push(...H.updaters)}).catch(H=>{console.warn("[NPC Loader] Failed to spawn GLB NPCs",H)});const ce=(H={})=>{const{baseRadius:ye=2.6,columnHeight:Ke=4.8,capHeight:gt=.9,textures:Z={}}=H,ee=new _t;ee.name="PlaceholderMonument";const Ie=!!H.collision;ee.userData.noCollision=!Ie;const Me=(qt,{collidable:Bi=Ie}={})=>{qt.castShadow=!0,qt.receiveShadow=!0,qt.userData.noCollision=!Bi},We=yy(),I={map:Z.map??We.map,normalMap:Z.normalMap??We.normalMap,roughnessMap:Z.roughnessMap??We.roughnessMap,aoMap:Z.aoMap??We.aoMap},L=H.baseMaterial??new tt({map:I.map,normalMap:I.normalMap,roughnessMap:I.roughnessMap,aoMap:I.aoMap,aoMapIntensity:1,metalness:0,roughness:.68,color:new oe(.95,.95,.95)}),z=typeof L.roughness=="number"?L.roughness:.45,V=typeof L.metalness=="number"?L.metalness:.05,Q=H.accentMaterial??(()=>{if(typeof L.clone=="function"){const qt=L.clone();return qt.color=new oe(H.accentColor??13350814),qt.roughness=H.accentRoughness??Math.max(0,z-.05),qt}return new tt({color:H.accentColor??13350814,roughness:H.accentRoughness??Math.max(0,z-.05),metalness:V,map:I.map,normalMap:I.normalMap,aoMap:I.aoMap,roughnessMap:I.roughnessMap})})(),Y=[],fe=[.28,.24,.2],pe=[1.35,1.22,1.1];let ae=0;fe.forEach((qt,Bi)=>{const Sr=pe[Bi]??1,Vi=new Lt(ye*Sr,ye*(Sr+.08),qt,48);Y.push(Vi);const gi=new Be(Vi,L);Me(gi);const Cr=Vi.parameters?.height??qt;ae+=Cr/2,gi.position.y=ae,ae+=Cr/2,ee.add(gi)});const Ne=.5,Pe=new Lt(ye*1.02,ye*1.08,Ne,48);Y.push(Pe);const Se=new Be(Pe,Q);Me(Se);const Te=Pe.parameters?.height??Ne;ae+=Te/2,Se.position.y=ae,ae+=Te/2,ee.add(Se);const je=new Lt(ye*.85,ye*.9,Ke,64,1);Y.push(je);const ht=new Be(je,L);Me(ht),ht.position.y=ae+Ke/2,ae+=Ke,ee.add(ht);const ft=new Lt(ye*1,ye*1.2,gt*.55,48);Y.push(ft);const pt=new Be(ft,Q);Me(pt);const qe=ft.parameters?.height??gt*.55;pt.position.y=ae+qe/2,ae+=qe,ee.add(pt);const St=gt*.75,lt=new Gi(ye*1.05,St,48,1,!1);Y.push(lt);const tn=new Be(lt,L);Me(tn),tn.position.y=ae+St/2,ae+=St,ee.add(tn);const mi=new Jn(ye*.22,24,16);Y.push(mi);const jt=new Be(mi,Q);Me(jt,{collidable:!1}),jt.position.y=ae+ye*.22,ae+=ye*.22*2,ee.add(jt),Y.forEach(qt=>{const Bi=qt.attributes?.uv;Bi&&qt.setAttribute("uv2",Bi.clone())});const Sn=new Be(new zo(ye*1.1,ye*1.75,64),new Bn({color:0,transparent:!0,opacity:.12,side:gn,depthWrite:!1}));Sn.rotation.x=-Math.PI/2,Sn.position.y=.015,Sn.renderOrder=1,Sn.castShadow=!1,Sn.receiveShadow=!1,Sn.userData.noCollision=!0,ee.add(Sn);const It=new fh(16773336,1.15,42,Math.PI/5,.35,1.2);It.position.set(6,ae*.5+5,6),It.castShadow=!1,It.shadow.mapSize.set(1024,1024),It.shadow.bias=-5e-4,It.userData.noCollision=!0,ee.add(It);const nn=new mt;nn.position.set(0,ae*.5,0),nn.userData.noCollision=!0,ee.add(nn),It.target=nn;const sn=new ss(13162239,.36,20,1.6);sn.position.set(-4,ae*.4+3.5,-3),sn.castShadow=!1,sn.userData.noCollision=!0,ee.add(sn);const Dt=new ss(16775132,.58,18,1.4);if(Dt.position.set(0,ae*.6+2.4,0),Dt.castShadow=!1,Dt.shadow.mapSize.set(512,512),Dt.shadow.bias=-6e-4,Dt.userData.noCollision=!0,ee.add(Dt),H.position instanceof C)ee.position.copy(H.position);else if(H.position&&typeof H.position=="object"){const{x:qt=0,y:Bi=0,z:Sr=0}=H.position;ee.position.set(qt,Bi,Sr)}typeof H.rotateY=="number"&&(ee.rotation.y=H.rotateY),H.scale instanceof C?ee.scale.copy(H.scale):typeof H.scale=="number"&&ee.scale.setScalar(H.scale);const Vt=ee.position.x,ai=ee.position.z;return gd(ee,b,Vt,ai,.05,{clampToSea:!0,seaLevel:ot,minAboveSea:.02}),(H.parent??v).add(ee),Ie&&M.refresh(),ee};xt($i,"models/buildings");const ze=(H,ye,Ke=.05)=>{let gt=Ke;if(typeof _e=="function"){const Z=_e(H,ye);Number.isFinite(Z)&&(gt=Z+Ke)}return new C(H,gt,ye)},it=[{url:xt($i,"models/landmarks/poseidon_temple.glb"),position:ze(-34,-12),rotateY:-Math.PI*.12,scale:1,collision:!0,name:"SamplePoseidonTemple"},{url:xt($i,"models/landmarks/akropol.glb"),position:ze(6,-42),rotateY:Math.PI*.08,scale:1,collision:!1,name:"SampleAkropol"}];(await Promise.allSettled(it.map(H=>be.loadBuilding(H.url,{position:H.position,rotateY:H.rotateY,scale:H.scale,collision:H.collision,parent:Oe,heightSampler:_e}).then(ye=>(ye&&H.name&&(ye.name=H.name),ye))))).forEach((H,ye)=>{H.status==="rejected"&&console.error(`Sample building failed to load: ${it[ye].url}`,H.reason)});const Mt=new yB({scene:v,parent:Oe,terrain:b,heightSampler:_e,envCollider:M,renderer:s,spawnPlaceholder:(H={})=>ce({...H,parent:H.parent??Oe}),quietMissing:!0});try{await Mt.loadConfig(bB)}catch(H){console.error("[LandmarkManager] Failed to load Athens layout",H)}Ce=KC(s,u,a),Qe&&xe(MB),hf(a,{safeMode:!0});const Pn=new nf,wn=NB(),fn={timeOfDayPhase:0};pu(fn,0);const xn=H=>{const ye=um[H];if(!ye)return;const Ke=pu(fn,ye.phase);s.toneMappingExposure=ye.exposure,console.log(`[HUD] preset: ${H}`);const gt=Jp(d,fn);Zp(f,gt),yA(S,f.nightFactor),qc(N,f.nightFactor),qc(O,f.nightFactor),jp(p,Ke),$p(x,gt),pA(w,0,gt,f.nightFactor),E&&(Su(f.nightFactor),FA(0,U?.position??null));const Z=i(Ke);Z!==r&&(n.textContent=`Time: ${Z}`,r=Z),s.render(a,u)};function Ti(){requestAnimationFrame(Ti);const H=Pn.getDelta(),ye=Pn.elapsedTime;if(wn.secondsPerDay>0){const Ie=H/wn.secondsPerDay,Me=(fn.timeOfDayPhase??0)+Ie,We=Me-Math.floor(Me);pu(fn,We)}const Ke=fn.timeOfDayPhase??0,gt=Jp(d,fn);Zp(f,gt),yA(S,f.nightFactor),qc(N,f.nightFactor),qc(O,f.nightFactor),jp(p,Ke),$p(x,gt),E&&(Su(f.nightFactor),FA(H,U?.position??null)),OM(b,ye),pA(w,H,gt,f.nightFactor),A.update(U?.position),Qe&&K&&(U.cameraYaw=Qe.getYaw(),U.cameraPitch=Qe.getPitch()),U.update(H),Qe&&K&&(U.cameraYaw=Qe.getYaw(),U.cameraPitch=Qe.getPitch()),Qe&&Qe.update(H);for(const Ie of me)Ie(H);const Z=Ce.updateHover(H);t.style.opacity=Z?"1":"0";const ee=i(Ke);ee!==r&&(n.textContent=`Time: ${ee}`,r=ee),s.render(a,u)}Ti();const Bs=()=>{try{if(U&&U.position&&Number.isFinite(U.position.x))return U.position}catch{}return u?.position??{x:0,y:0,z:0}},cs=()=>{try{const H=new C(0,0,-1);return H.applyQuaternion(u.quaternion),H.y=0,H.normalize(),H}catch{return{x:0,y:0,z:1}}},zi=H=>{const ye=dB(v,H),Ke=b?.userData?.getHeightAt?.(H.x,H.z);Number.isFinite(Ke)&&(ye.position.y=Ke)};typeof window<"u"&&(window.SHOW_HUD=!0),console.log("[HUD] mounting…");const Hi=lB({getPosition:Bs,getDirection:cs,onPin:zi,onSetLightingPreset:xn,lightingPresets:um});uB(Hi?.rootElement??null),g&&Hi?.setStatusLine?.("audio","Audio: Off (no manifest)"),s.domElement.addEventListener("pointerdown",H=>{if(H.button===0){if(K&&Qe)return;Ce.useObject()}}),window.addEventListener("keydown",H=>{H.code==="KeyV"&&!H.repeat&&Qe?xe(!K):H.code==="KeyE"&&Ce.useObject()}),window.addEventListener("resize",()=>{u.aspect=window.innerWidth/window.innerHeight,u.updateProjectionMatrix(),s.setSize(window.innerWidth,window.innerHeight)})}(async()=>{try{await kB(),console.log("✅ mainApp loaded successfully")}catch(s){console.error("❌ Error in mainApp:",s)}})();
